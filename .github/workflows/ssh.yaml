name: Agentless Ngrok Tunnel to Runner

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: ubuntu-latest

    steps:
      - name: Install SSH server and client
        run: |
          sudo apt update
          sudo apt install -y openssh-server openssh-client
          sudo systemctl enable ssh
          sudo systemctl start ssh

      - name: Configure SSH access policy
        env:
          ALLOWED_SSH_KEY: ${{ secrets.ALLOWED_SSH_KEY }}
        run: |
          # Configure SSH to accept only the provided key
          sudo mkdir -p /root/.ssh
          echo "$ALLOWED_SSH_KEY" | sudo tee /root/.ssh/authorized_keys > /dev/null
          sudo chmod 700 /root/.ssh
          sudo chmod 600 /root/.ssh/authorized_keys

          echo /etc/ssh/sshd_config BEFORE:
          cat /etc/ssh/sshd_config

          # Disable password auth, enforce key-only, limit root login
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?UsePAM.*/UsePAM no/' /etc/ssh/sshd_config

          echo /etc/ssh/sshd_config AFTER:
          cat /etc/ssh/sshd_config

          sudo systemctl restart ssh
          echo "SSH server running and restricted to ALLOWED_SSH_KEY."

      - name: Expose SSH via Ngrok (agentless)
        env:
          NGROK_SSH_PRIVATE_KEY: ${{ secrets.NGROK_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$NGROK_SSH_PRIVATE_KEY" > ~/.ssh/ngrok_temp
          chmod 600 ~/.ssh/ngrok_temp

          echo "Connecting to ngrok edge..."
          ssh -i ~/.ssh/ngrok_temp \
              -o StrictHostKeyChecking=no \
              -R 0:localhost:22 \
              v2@connect.ngrok-agent.com tcp
